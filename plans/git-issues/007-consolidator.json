{
  "number": 7,
  "title": "Consolidator: ingredient merging and shopping list generation",
  "state": "open",
  "labels": [
    {"name": "phase:2-core"},
    {"name": "priority:P0"},
    {"name": "component:backend"}
  ],
  "milestone": {"title": "Phase 2: Replace Stubs"},
  "body": "## Summary\n\nReplace the stub `consolidator.py` with real Claude-powered ingredient consolidation. This takes parsed meals + restock queue + pantry state and produces the final shopping list.\n\n## Context\n\nThe consolidator is the last step in the core pipeline before output. It:\n1. Collects all `purchase_items` from parsed meals\n2. Merges identical ingredients (same item + form), sums quantities\n3. Applies pantry exclusions (respecting inventory overrides)\n4. Appends restock queue items\n5. Rounds to store-friendly quantities\n6. Adds `search_term` for each item (grocery-store-friendly phrasing for future Safeway search)\n\nClaude handles the smart merging and rounding. The consolidator provides the context.\n\n## Acceptance Criteria\n\n### Consolidator class\n\nConstructor:\n- [ ] `__init__(self, anthropic_client, config)` — inject dependencies\n\n### Core method\n- [ ] `consolidate(meals: list[ParsedMeal], restock_queue: list[InventoryItem], pantry_staples: list[str], inventory_overrides: list[str] | None = None) -> list[ShoppingListItem]`\n- [ ] Build prompt context:\n  - Flatten all `purchase_items` from all meals into ingredient list with `from_meals` tracking\n  - Format pantry staples list\n  - Format restock queue (items with status low/out, including their `default_quantity` and `default_unit`)\n  - Format inventory overrides (staples that need restocking)\n- [ ] Call Claude with `ingredient_consolidation.txt` prompt\n- [ ] Parse response into `list[ShoppingListItem]` via Pydantic\n- [ ] Each item has: `ingredient`, `quantity`, `unit`, `category`, `search_term`, `from_meals`, `estimated_price` (nullable)\n- [ ] Retry once on invalid JSON\n\n### Key merge rules (enforced by prompt, validated in tests)\n- [ ] Same ingredient from multiple meals: quantities summed\n- [ ] Different cuts of same protein NOT merged (chicken thighs != chicken breast)\n- [ ] Produce rounded to whole units\n- [ ] Meat rounded to nearest 0.5 lb\n- [ ] Dairy rounded to standard container sizes\n- [ ] Restock items appended with `from_meals: [\"restock\"]`\n- [ ] Pantry staples excluded UNLESS they appear in inventory overrides list\n\n### Fallback (no Claude)\n- [ ] `consolidate_simple(meals: list[ParsedMeal], restock_queue: list[InventoryItem], pantry_staples: list[str]) -> list[ShoppingListItem]` — pure Python fallback that does basic dedup + sum without Claude. Used when API is unavailable or in tests.\n\n### Tests (tests/test_consolidator.py)\n- [ ] Test same ingredient from 2 meals gets summed\n- [ ] Test different protein cuts stay separate\n- [ ] Test pantry staple excluded by default\n- [ ] Test pantry staple included when in inventory override list\n- [ ] Test restock items appended with from_meals=[\"restock\"]\n- [ ] Test Claude response parsing with mock client\n- [ ] Test `consolidate_simple` fallback (no Claude needed)\n- [ ] Test empty meals list returns only restock items\n\n## Blocked By\n\n#1 (models), #3 (prompt templates), #6 (meal parser — produces the input)\n\n## Blocks\n\n#8 (web dashboard shopping list), #10 (Discord bot /meals command)"
}
