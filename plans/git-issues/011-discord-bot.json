{
  "number": 11,
  "title": "Discord bot: slash commands, natural language inventory, and clarification dialogs",
  "state": "open",
  "labels": [
    {"name": "phase:3-ui"},
    {"name": "priority:P2"},
    {"name": "component:bot"}
  ],
  "milestone": {"title": "Phase 3: User Interfaces"},
  "body": "## Summary\n\nBuild the Discord bot with all slash commands and natural language inventory parsing. This is the conversational interface to MealBot — the other way to interact besides the web dashboard.\n\n## Context\n\nUses `discord.py` with async. Single-server, single-authorized-user (via `DISCORD_USER_ID` env var). Shares the same SQLite database as the Flask app (WAL mode). The bot runs as a separate process from Flask.\n\nSince the backend modules (recipe_store, pantry_manager, meal_parser, consolidator) are synchronous SQLite, use `asyncio.to_thread()` or `loop.run_in_executor()` to call them from async Discord handlers.\n\n## Acceptance Criteria\n\n### Bot setup (grocery_butler/bot.py)\n- [ ] `discord.py` Bot with intents\n- [ ] Auth check: only respond to `DISCORD_USER_ID` from config\n- [ ] Graceful startup: validate config, init DB, register commands\n- [ ] Graceful shutdown: clean up connections\n\n### Slash commands\n\n#### /meals\n- [ ] `/meals <meal1>, <meal2>, <meal3>` — run full pipeline\n- [ ] Parse comma-separated meal names\n- [ ] Call meal_parser.parse_meals() -> consolidator.consolidate()\n- [ ] Post formatted shopping list as embed or code block\n- [ ] Group by category, show quantities and from_meals\n- [ ] Flag unknown recipes with \"needs confirmation\" indicator\n- [ ] Optional: offer to save unknown recipes\n\n#### /pantry\n- [ ] `/pantry list` — show all pantry staples\n- [ ] `/pantry add <ingredient> [category]` — add staple\n- [ ] `/pantry remove <ingredient>` — remove staple\n- [ ] Confirmation messages for add/remove\n\n#### /stock\n- [ ] `/stock` — show full inventory with status indicators (emoji: green/yellow/red circle)\n- [ ] `/stock out <item>` — mark item as out\n- [ ] `/stock low <item>` — mark item as low\n- [ ] `/stock good <item>` — mark item as on_hand\n- [ ] `/stock add <item> [category]` — track new item\n- [ ] Confirmation messages\n\n#### /restock\n- [ ] `/restock` — show restock queue (low + out items)\n- [ ] `/restock clear` — clear queue, confirm count\n\n#### /brands\n- [ ] `/brands` — show all brand preferences\n- [ ] `/brands set <target> <brand>` — set preferred brand\n- [ ] `/brands avoid <brand>` — add to avoid list\n- [ ] `/brands clear <target>` — remove preference\n\n#### /recipes\n- [ ] `/recipes list` — list saved recipes (name + times ordered)\n- [ ] `/recipes show <name>` — show recipe detail with ingredients\n- [ ] `/recipes forget <name>` — delete recipe with confirmation\n\n#### /preferences\n- [ ] `/preferences` — show current preferences\n- [ ] `/preferences set <key> <value>` — update preference\n\n### Natural language handling\n- [ ] Any non-command message from authorized user -> pass to `pantry_manager.parse_inventory_intent()`\n- [ ] If inventory update detected with confidence >= 0.8: act on it, confirm (\"Got it, marked milk as out\")\n- [ ] If confidence < 0.8: ask for clarification (\"Did you mean you're out of milk?\")\n- [ ] If not an inventory update: ignore silently\n\n### Clarification dialog (unknown recipes)\n- [ ] When meal parser flags `needs_confirmation=True`, enter multi-turn dialog\n- [ ] Store dialog state per-user in memory dict with 5-minute timeout\n- [ ] Accept: rough ingredient lists, URLs, or natural language descriptions\n- [ ] After confirmation: save recipe to memory\n- [ ] On timeout: cancel dialog, inform user\n\n### Error handling\n- [ ] All commands respond to user even on failure (\"Something went wrong — try again?\")\n- [ ] Claude API errors: friendly message, not stack trace\n- [ ] Unknown item in /stock: suggest creating it\n- [ ] Autocomplete for item names where discord.py supports it\n\n## File Inventory\n\n```\ngrocery_butler/\n└── bot.py\n```\n\n## Blocked By\n\n#4 (recipe store), #5 (pantry manager), #6 (meal parser), #7 (consolidator)\n\n## Blocks\n\nNothing — this is the final component."
}
