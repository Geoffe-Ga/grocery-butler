{
  "number": 5,
  "title": "Pantry manager: inventory tracking, restock queue, and status lifecycle",
  "state": "open",
  "labels": [
    {"name": "phase:2-core"},
    {"name": "priority:P0"},
    {"name": "component:backend"}
  ],
  "milestone": {"title": "Phase 2: Replace Stubs"},
  "body": "## Summary\n\nReplace the stub `pantry_manager.py` with real inventory tracking. This manages the household inventory lifecycle (on_hand -> low -> out) and produces the restock queue that feeds into the shopping list.\n\n## Context\n\nThe critical business rule lives here: **pantry staples are excluded from shopping lists UNLESS the inventory says the item is 'low' or 'out'.** If salt is a pantry staple but inventory says 'out', salt gets INCLUDED in the order. If an item is a staple but not tracked in inventory at all, assume on_hand.\n\nThe pantry manager also handles Claude-powered natural language inventory updates (\"we're out of milk\").\n\n## Acceptance Criteria\n\n### PantryManager class\n\nConstructor:\n- [ ] `__init__(self, db_path: str, anthropic_client=None)` — anthropic client optional (for NL parsing)\n\n### Inventory CRUD\n- [ ] `get_inventory() -> list[InventoryItem]` — all tracked items\n- [ ] `get_item(ingredient: str) -> InventoryItem | None` — lookup by normalized ingredient name\n- [ ] `add_item(item: InventoryItem) -> int` — add new tracked item\n- [ ] `remove_item(ingredient: str) -> None`\n- [ ] `update_status(ingredient: str, new_status: InventoryStatus) -> None` — update status + `last_status_change` timestamp\n- [ ] `mark_restocked(ingredients: list[str]) -> int` — move matching items back to `on_hand`, set `last_restocked`. Use fuzzy matching. Return count of items updated.\n\n### Restock queue\n- [ ] `get_restock_queue() -> list[InventoryItem]` — all items with status 'low' or 'out'\n- [ ] `clear_restock_queue() -> int` — set all low/out items to on_hand, return count\n\n### Pantry-inventory interaction\n- [ ] `should_include_in_order(ingredient: str, recipe_store: RecipeStore) -> bool` — implements the override rule:\n  1. If ingredient is NOT a pantry staple -> True (always include)\n  2. If ingredient IS a pantry staple AND inventory says 'low' or 'out' -> True (override)\n  3. If ingredient IS a pantry staple AND inventory says 'on_hand' -> False (exclude)\n  4. If ingredient IS a pantry staple AND NOT tracked in inventory -> False (assume on_hand)\n\n### Natural language inventory parsing\n- [ ] `parse_inventory_intent(message: str) -> list[InventoryUpdate]` — calls Claude API with `inventory_intent.txt` prompt\n- [ ] Passes current inventory as context to Claude\n- [ ] Parses Claude's JSON response into `list[InventoryUpdate]`\n- [ ] Filters out low-confidence matches (< 0.8) and returns them with a flag\n- [ ] Retry once if Claude returns invalid JSON\n- [ ] Returns empty list if anthropic_client is None (graceful degradation)\n\n### Tests (tests/test_pantry_manager.py)\n- [ ] Test status lifecycle: on_hand -> low -> out -> on_hand (via restocked)\n- [ ] Test restock queue only returns low/out items\n- [ ] Test `clear_restock_queue` resets all to on_hand\n- [ ] Test `mark_restocked` with fuzzy matching (\"Olive Oil\" matches \"olive oil\")\n- [ ] Test pantry-inventory override rule (all 4 cases above)\n- [ ] Test `parse_inventory_intent` with mocked Claude client returning valid JSON\n- [ ] Test `parse_inventory_intent` with mocked invalid JSON (retry behavior)\n- [ ] Test `parse_inventory_intent` returns empty when no client provided\n- [ ] Use in-memory SQLite for test isolation\n\n## Blocked By\n\n#1 (foundation), #3 (prompt templates — needs inventory_intent.txt)\n\n## Blocks\n\n#7 (consolidator reads restock queue), #8 (web dashboard inventory page), #10 (Discord bot inventory commands)"
}
